# Storage

프로메테우스는 로컬 디스크 기반 시계열 데이터베이스를 가지고 있지만,      
원한다면 원격 스토리지 시스템과 통합하는 것도 가능하다.     

## Local Storage
    
프로메테우스의 로컬 시계열 데이터베이스는       
**로컬 스토리지에 데이터를 저장하며, 커스텀한 형식을 적용해 저장 효율을 높인다.**      

### On-disk layout   
            
* 수집한 샘플들은 2시간 짜리 블록으로 묶인다.       
* 각 블록은 `chunks 디렉토리`, `메타데이터 파일`, `인덱스 파일`이 담겨있는 디렉토리로 구성된다.          
    * chunks 디렉토리 : 각 time 윈도우에서 수집한 모든 시계열 샘플이 담겨있음       
    * 인덱스 파일 : 메트릭명과 레이블로 chunks 디렉토리에 있는 시계열을 인덱싱하는 파일             
* chunks 디렉토리에 있는 샘플들은 **하나 이상의 세그먼트 파일로 묶이며, 기본적으로 각 세그먼트 파일은 최대 512MB 를 사용한다.**             
* API를 통해 시계열을 삭제하면 **별도의 톰스톤 파일에 삭제 레코드를 저장한다. (청크 세그먼트에서 곧바로 데이터를 삭제하지 않는다)**          
                    
현재 샘플을 수집 중인 블록은 메모리에 유지하며, 완전하게 저장되진(persisted) 않은 상태다.              
프로메테우스 서버에서 크래시가 발생해 재시작되면 WAL(write-ahead log)을 리플레이해서 블록을 복구한다.      
   
WAL 파일은 `wal` 디렉토리에 128MB 세그먼트들로 나뉘어 저장된다.        
이 파일에는 아직 컴팩션(compaction) 과정을 거치지 않은 원시 데이터가 들어있다.    
그렇기 때문에 일반적인 블록 파일보다 사이즈가 훨씬 크다.       
프로메테우스는 WAL 파일을 최소 3개는 유지한다.    
트래픽이 많은 서버는 적어도 2시간짜리 원시 데이터를 유지하기 위해 WAL 파일을 3개 이상 보유할 수도 있다.     

```
./data
├── 01BKGV7JBM69T2G1BGBGM6KB12
│   └── meta.json
├── 01BKGTZQ1SYQJTR4PB43C8PD98
│   ├── chunks
│   │   └── 000001
│   ├── tombstones
│   ├── index
│   └── meta.json
├── 01BKGTZQ1HHWHV8FBJXW1Y3W0K
│   └── meta.json
├── 01BKGV7JC0RY8A6MACW02A2PJD
│   ├── chunks
│   │   └── 000001
│   ├── tombstones
│   ├── index
│   └── meta.json
├── chunks_head
│   └── 000001
└── wal
    ├── 000000002
    └── checkpoint.00000001
        └── 00000000
```
     
로컬 스토리지를 이용할 때는 **클러스터링이나 복제가 불가능하다는 제약이 있다.**             
**따라서 드라이브나 노드가 중단되면 자체적으로 확장하거나 내구성을 보장할 수 없으며, 단일 노드 데이터베이스처럼 관리해야 한다.**       
스토리지 가용성을 위해선 RAID 를 사용하고, 스냅샷을 통해 백업해두는 것을 권장한다.         
적절한 아키텍처만 적용해주면 로컬 스토리지에 수년간의 데이터를 보관할 수 있다.      
   
아니면 [remote read/write api](https://godekdls.github.io/Prometheus/integrations/#remote-endpoints-and-storage)를 통해 외부 저장소를 사용할 수도 있다.       
이런 시스템들은 내구성이나 성능 효율성 면에서 크게 갈리기 때문에 신중하게 평가하고 사용해야한다.  

파일 형식에 관한 자세한 내용은 [TDSB 포맷](https://github.com/prometheus/prometheus/blob/release-2.32/tsdb/docs/format/README.md) 참고하라

## Compaction
        
처음에 만들었던 2시간짜리 블록은 시간이 지나면 **백그라운드에서 좀 더 긴 블록으로 압축된다.**           
컴팩션을 마치면 보존 시간의 10% 나 31일 중 더 작은 기간에 속하는 데이터들을 가지는 더 큰 블록이 만들어진다.  
